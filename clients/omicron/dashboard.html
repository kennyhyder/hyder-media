<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Dashboard | Omicron Google Ads</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .dashboard-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .dashboard-actions {
            display: flex;
            gap: 12px;
        }

        .top-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        @media (max-width: 1200px) {
            .top-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .top-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .view-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }

        .view-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .view-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .view-tab.active {
            background: var(--accent);
            color: white;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .legend-inline {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .group-header {
            background: var(--bg-tertiary);
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .group-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .group-stats {
            display: flex;
            gap: 32px;
        }

        .group-stat {
            text-align: right;
        }

        .group-stat-value {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .group-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .account-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 24px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .account-row:last-child {
            border-bottom: none;
        }

        .account-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .account-icon-sm {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
        }

        .account-details {
            flex: 1;
        }

        .account-name-sm {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .account-spend {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .mini-charts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .mini-chart {
            height: 80px;
        }

        .mini-chart-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 4px;
        }

        .data-source-note {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 8px;
        }

        .demo-badge {
            background: var(--warning);
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .brand-color { color: #ef4444; }
        .nonbrand-color { color: #3b82f6; }

        .conv-account-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .conv-account-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .conv-account-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .conv-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .sku-colors {
            --sku-1: #22c55e;
            --sku-2: #16a34a;
            --sku-3: #15803d;
            --sku-4: #166534;
            --sku-5: #14532d;
            --sku-6: #86efac;
            --sku-7: #4ade80;
            --sku-8: #bbf7d0;
        }
    </style>
</head>
<body>
    <!-- Auth Check -->
    <script>
        (function() {
            const AUTH_KEY = 'omicron_dashboard_auth';
            if (sessionStorage.getItem(AUTH_KEY) !== 'authenticated') {
                window.location.href = 'password.html';
            }
        })();
    </script>

    <!-- Navigation -->
    <nav class="main-nav">
        <a href="summary.html" class="nav-brand">
            <img src="../../assets/imgs/logos/hyder-media-icon.png" alt="Hyder Media">
            Omicron Google Ads
        </a>
        <div class="nav-links">
            <a href="summary.html" class="nav-link">Summary</a>
            <a href="dashboard.html" class="nav-link active">Dashboard</a>
            <a href="legacy-dashboard.html" class="nav-link">Legacy View</a>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div>
                <h1 class="dashboard-title">PPC Performance Dashboard <span class="demo-badge" id="data-badge">LOADING...</span></h1>
                <p class="text-muted">Monthly trends with Brand vs Non-Brand breakdown</p>
            </div>
            <div class="dashboard-actions">
                <select id="months-selector" onchange="changeMonths()" style="padding: 8px 12px; border-radius: 6px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);">
                    <option value="3">Last 3 Months</option>
                    <option value="6">Last 6 Months</option>
                    <option value="13" selected>Last 13 Months</option>
                </select>
                <button class="btn btn-secondary btn-sm" onclick="refreshData()">
                    <span id="refresh-icon">↻</span> Refresh
                </button>
                <button class="btn btn-primary btn-sm" onclick="exportCSV()">
                    Export CSV
                </button>
            </div>
        </div>

        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" onclick="switchView('overview')">Overview</button>
            <button class="view-tab" onclick="switchView('review')">Review Sites</button>
            <button class="view-tab" onclick="switchView('owned')">Owned Sites</button>
            <button class="view-tab" onclick="switchView('conversions')">SKU / Brand</button>
            <button class="view-tab" onclick="switchView('accounts')">Account Details</button>
        </div>

        <!-- Overview Section -->
        <div id="view-overview" class="view-section active">
            <!-- Top Stats -->
            <div class="top-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Spend</div>
                    <div class="stat-value" id="total-spend">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Conversions</div>
                    <div class="stat-value" id="total-conversions">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg CPA</div>
                    <div class="stat-value" id="avg-cpa">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Brand CPA</div>
                    <div class="stat-value brand-color" id="brand-cpa">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Non-Brand CPA</div>
                    <div class="stat-value nonbrand-color" id="nonbrand-cpa">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Clicks</div>
                    <div class="stat-value" id="total-clicks">0</div>
                </div>
            </div>

            <!-- All Conversions Chart -->
            <div class="card mb-6">
                <div class="card-header">
                    <h2 class="card-title">All Conversions</h2>
                </div>
                <div class="legend-inline">
                    <div class="legend-item"><div class="legend-dot" style="background: #3b82f6;"></div> Non-Brand</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #ef4444;"></div> Brand</div>
                </div>
                <div class="chart-container">
                    <canvas id="all-conv-chart"></canvas>
                </div>
            </div>

            <!-- CPA Trend Chart -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">CPA Trend (Brand vs Non-Brand)</div>
                    <div class="chart-container">
                        <canvas id="cpa-trend-chart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Cost Distribution</div>
                    <div class="chart-container">
                        <canvas id="cost-dist-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Sites Section -->
        <div id="view-review" class="view-section">
            <div class="group-header">
                <div>
                    <div class="group-title">Review Sites (BUR + Top10usenet)</div>
                    <div class="group-subtitle">Affiliate review sites driving referral traffic</div>
                </div>
                <div class="group-stats">
                    <div class="group-stat">
                        <div class="group-stat-value" id="review-spend">$0</div>
                        <div class="group-stat-label">Total Spend</div>
                    </div>
                    <div class="group-stat">
                        <div class="group-stat-value" id="review-conv">0</div>
                        <div class="group-stat-label">Conversions</div>
                    </div>
                    <div class="group-stat">
                        <div class="group-stat-value" id="review-cpa">$0</div>
                        <div class="group-stat-label">CPA</div>
                    </div>
                </div>
            </div>

            <div class="card mb-6">
                <div class="card-header">
                    <h2 class="card-title">Review Sites Conversions</h2>
                </div>
                <div class="legend-inline">
                    <div class="legend-item"><div class="legend-dot" style="background: #3b82f6;"></div> Non-Brand</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #ef4444;"></div> Brand</div>
                </div>
                <div class="chart-container">
                    <canvas id="review-conv-chart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Review Sites CPA</div>
                    <div class="chart-container">
                        <canvas id="review-cpa-chart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Review Sites Cost</div>
                    <div class="chart-container">
                        <canvas id="review-cost-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Owned Sites Section -->
        <div id="view-owned" class="view-section">
            <div class="group-header">
                <div>
                    <div class="group-title">Owned Sites (8 Brands)</div>
                    <div class="group-subtitle">Direct-to-consumer Usenet provider brands</div>
                </div>
                <div class="group-stats">
                    <div class="group-stat">
                        <div class="group-stat-value" id="owned-spend">$0</div>
                        <div class="group-stat-label">Total Spend</div>
                    </div>
                    <div class="group-stat">
                        <div class="group-stat-value" id="owned-conv">0</div>
                        <div class="group-stat-label">Conversions</div>
                    </div>
                    <div class="group-stat">
                        <div class="group-stat-value" id="owned-cpa">$0</div>
                        <div class="group-stat-label">CPA</div>
                    </div>
                </div>
            </div>

            <div class="card mb-6">
                <div class="card-header">
                    <h2 class="card-title">Owned Sites Conversions</h2>
                </div>
                <div class="legend-inline">
                    <div class="legend-item"><div class="legend-dot" style="background: #3b82f6;"></div> Non-Brand</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #ef4444;"></div> Brand</div>
                </div>
                <div class="chart-container">
                    <canvas id="owned-conv-chart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Owned Sites CPA</div>
                    <div class="chart-container">
                        <canvas id="owned-cpa-chart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Owned Sites Cost</div>
                    <div class="chart-container">
                        <canvas id="owned-cost-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- SKU / Brand Conversions Section -->
        <div id="view-conversions" class="view-section">
            <div class="group-header">
                <div>
                    <div class="group-title">Conversion Action Breakdown</div>
                    <div class="group-subtitle">Review Sites show brand attribution, Owned Sites show SKU/product selection</div>
                </div>
                <div class="dashboard-actions">
                    <button class="btn btn-secondary btn-sm" onclick="refreshConversionData()">
                        <span id="conv-refresh-icon">↻</span> Load Data
                    </button>
                </div>
            </div>

            <!-- Account selector for conversion details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title">Select Account</h2>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; padding: 16px;">
                    <button class="conv-account-btn active" data-account="BUR" onclick="selectConversionAccount('BUR')">
                        <span class="conv-dot" style="background: #3b82f6;"></span> BUR (Brand Conv.)
                    </button>
                    <button class="conv-account-btn" data-account="Top10usenet" onclick="selectConversionAccount('Top10usenet')">
                        <span class="conv-dot" style="background: #ec4899;"></span> Top10 (Brand Conv.)
                    </button>
                    <button class="conv-account-btn" data-account="Eweka" onclick="selectConversionAccount('Eweka')">
                        <span class="conv-dot" style="background: #22c55e;"></span> Eweka (SKUs)
                    </button>
                    <button class="conv-account-btn" data-account="Newshosting" onclick="selectConversionAccount('Newshosting')">
                        <span class="conv-dot" style="background: #8b5cf6;"></span> Newshosting (SKUs)
                    </button>
                    <button class="conv-account-btn" data-account="Easynews" onclick="selectConversionAccount('Easynews')">
                        <span class="conv-dot" style="background: #f59e0b;"></span> Easynews (SKUs)
                    </button>
                    <button class="conv-account-btn" data-account="UsenetServer" onclick="selectConversionAccount('UsenetServer')">
                        <span class="conv-dot" style="background: #14b8a6;"></span> UsenetServer (SKUs)
                    </button>
                    <button class="conv-account-btn" data-account="Tweak" onclick="selectConversionAccount('Tweak')">
                        <span class="conv-dot" style="background: #ef4444;"></span> Tweak (SKUs)
                    </button>
                    <button class="conv-account-btn" data-account="Privado" onclick="selectConversionAccount('Privado')">
                        <span class="conv-dot" style="background: #10b981;"></span> Privado (SKUs)
                    </button>
                </div>
            </div>

            <!-- Conversion action chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title" id="conv-chart-title">BUR: Brand Conversions</h2>
                </div>
                <div id="conv-legend" class="legend-inline" style="flex-wrap: wrap; padding: 0 16px;">
                    <!-- Populated by JS -->
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="conv-breakdown-chart"></canvas>
                </div>
            </div>

            <!-- Conversion totals table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Conversion Action Totals</h2>
                </div>
                <div class="table-container" style="border: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Conversion Action</th>
                                <th style="text-align: right;">Conversions</th>
                                <th style="text-align: right;">% of Total</th>
                            </tr>
                        </thead>
                        <tbody id="conv-totals-table">
                            <tr><td colspan="3" class="text-muted">Click "Load Data" to fetch conversion action data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Account Details Section -->
        <div id="view-accounts" class="view-section">
            <div id="account-details-container">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Data Source Note -->
        <p class="data-source-note" id="data-source-note">
            Loading data from Google Ads API...
        </p>

        <!-- Footer -->
        <footer class="footer">
            <p>Omicron Media Dashboard prepared by <a href="https://hyder.me" target="_blank">Hyder Media</a></p>
        </footer>
    </div>

    <script>
        // Store API data
        let apiData = null;
        let isLoading = false;

        // Chart instances
        let charts = {};

        // Account color map
        const accountColors = {
            'Eweka': '#22c55e',
            'Easynews': '#f59e0b',
            'Newshosting': '#8b5cf6',
            'UsenetServer': '#14b8a6',
            'Tweak': '#ef4444',
            'Pure': '#6366f1',
            'Sunny': '#eab308',
            'BUR': '#3b82f6',
            'Top10usenet': '#ec4899',
            'Privado': '#10b981'
        };

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value || 0);
        }

        // Format number
        function formatNumber(value) {
            return new Intl.NumberFormat('en-US').format(Math.round(value || 0));
        }

        // Format month for display (2025-01 -> Jan 2025)
        function formatMonth(monthStr) {
            if (!monthStr) return '';
            const [year, month] = monthStr.split('-');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[parseInt(month, 10) - 1] + ' ' + year.slice(2);
        }

        // Switch view tabs (with URL hash support for direct linking)
        function switchView(view, updateHash = true) {
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));

            document.querySelector(`[onclick="switchView('${view}')"]`).classList.add('active');
            document.getElementById(`view-${view}`).classList.add('active');

            // Update URL hash for direct linking (e.g., dashboard.html#accounts)
            if (updateHash) {
                history.replaceState(null, null, `#${view}`);
            }
        }

        // Handle URL hash on page load and hash changes
        function handleHashNavigation() {
            const hash = window.location.hash.replace('#', '');
            const validViews = ['overview', 'review', 'owned', 'conversions', 'accounts'];
            if (hash && validViews.includes(hash)) {
                switchView(hash, false);
            }
        }

        // Listen for hash changes (browser back/forward)
        window.addEventListener('hashchange', handleHashNavigation);

        // Change months selector
        function changeMonths() {
            refreshData();
        }

        // Fetch data from API
        async function fetchApiData() {
            const months = document.getElementById('months-selector').value;
            isLoading = true;
            updateLoadingState();

            try {
                const response = await fetch(`/api/google-ads/omicron-monthly?months=${months}`);
                apiData = await response.json();

                if (apiData.errors && apiData.errors.length > 0) {
                    console.error('API errors:', apiData.errors);
                }

                // Update badge
                const badge = document.getElementById('data-badge');
                const successCount = apiData.accounts?.filter(a => a.status === 'success').length || 0;
                const errorCount = apiData.accounts?.filter(a => a.status !== 'success').length || 0;

                if (successCount === 0) {
                    badge.textContent = 'NO DATA';
                    badge.style.background = '#ef4444';
                } else if (errorCount > 0) {
                    badge.textContent = `${successCount} LIVE / ${errorCount} ERRORS`;
                    badge.style.background = '#f59e0b';
                } else {
                    badge.textContent = 'LIVE DATA';
                    badge.style.background = '#22c55e';
                }

                // Update data source note
                document.getElementById('data-source-note').innerHTML =
                    `Data from Google Ads API | ${apiData.dateRange?.start || ''} to ${apiData.dateRange?.end || ''} | ${successCount} accounts`;

                isLoading = false;
                updateDashboard();

            } catch (error) {
                console.error('Failed to fetch API data:', error);
                document.getElementById('data-badge').textContent = 'API ERROR';
                document.getElementById('data-badge').style.background = '#ef4444';
                document.getElementById('data-source-note').innerHTML =
                    `Failed to load data: ${error.message}. <a href="/api/google-ads/auth?returnUrl=/clients/omicron/dashboard.html">Try reconnecting</a>`;
                isLoading = false;
            }
        }

        function updateLoadingState() {
            if (isLoading) {
                document.getElementById('data-badge').textContent = 'LOADING...';
                document.getElementById('data-badge').style.background = '#3b82f6';
            }
        }

        // Update dashboard with data
        function updateDashboard() {
            if (!apiData || !apiData.monthlyTotals) return;

            // Calculate totals from monthly data
            const totals = apiData.monthlyTotals.reduce((acc, m) => {
                acc.spend += m.total?.spend || 0;
                acc.conversions += m.total?.conversions || 0;
                acc.clicks += m.total?.clicks || 0;
                acc.brandSpend += m.brand?.spend || 0;
                acc.brandConv += m.brand?.conversions || 0;
                acc.nonBrandSpend += m.nonBrand?.spend || 0;
                acc.nonBrandConv += m.nonBrand?.conversions || 0;
                return acc;
            }, { spend: 0, conversions: 0, clicks: 0, brandSpend: 0, brandConv: 0, nonBrandSpend: 0, nonBrandConv: 0 });

            // Update top stats
            document.getElementById('total-spend').textContent = formatCurrency(totals.spend);
            document.getElementById('total-conversions').textContent = formatNumber(totals.conversions);
            document.getElementById('avg-cpa').textContent = formatCurrency(totals.conversions > 0 ? totals.spend / totals.conversions : 0);
            document.getElementById('brand-cpa').textContent = formatCurrency(totals.brandConv > 0 ? totals.brandSpend / totals.brandConv : 0);
            document.getElementById('nonbrand-cpa').textContent = formatCurrency(totals.nonBrandConv > 0 ? totals.nonBrandSpend / totals.nonBrandConv : 0);
            document.getElementById('total-clicks').textContent = formatNumber(totals.clicks);

            // Update group stats
            if (apiData.groupTotals) {
                const reviewTotals = apiData.groupTotals.review?.reduce((acc, m) => {
                    acc.spend += m.total?.spend || 0;
                    acc.conversions += m.total?.conversions || 0;
                    return acc;
                }, { spend: 0, conversions: 0 }) || { spend: 0, conversions: 0 };

                const ownedTotals = apiData.groupTotals.owned?.reduce((acc, m) => {
                    acc.spend += m.total?.spend || 0;
                    acc.conversions += m.total?.conversions || 0;
                    return acc;
                }, { spend: 0, conversions: 0 }) || { spend: 0, conversions: 0 };

                document.getElementById('review-spend').textContent = formatCurrency(reviewTotals.spend);
                document.getElementById('review-conv').textContent = formatNumber(reviewTotals.conversions);
                document.getElementById('review-cpa').textContent = formatCurrency(reviewTotals.conversions > 0 ? reviewTotals.spend / reviewTotals.conversions : 0);

                document.getElementById('owned-spend').textContent = formatCurrency(ownedTotals.spend);
                document.getElementById('owned-conv').textContent = formatNumber(ownedTotals.conversions);
                document.getElementById('owned-cpa').textContent = formatCurrency(ownedTotals.conversions > 0 ? ownedTotals.spend / ownedTotals.conversions : 0);
            }

            // Update charts
            updateCharts();
            updateAccountDetails();
        }

        // Initialize charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    }
                }
            };

            // All Conversions Chart (stacked bar)
            charts.allConv = new Chart(document.getElementById('all-conv-chart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatNumber(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, stacked: true },
                        y: { ...chartOptions.scales.y, stacked: true }
                    }
                }
            });

            // CPA Trend Chart (grouped bar)
            charts.cpaTrend = new Chart(document.getElementById('cpa-trend-chart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            ticks: { ...chartOptions.scales.y.ticks, callback: v => '$' + v }
                        }
                    }
                }
            });

            // Cost Distribution Chart (stacked percentage)
            charts.costDist = new Chart(document.getElementById('cost-dist-chart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, stacked: true },
                        y: {
                            ...chartOptions.scales.y,
                            stacked: true,
                            max: 100,
                            ticks: { ...chartOptions.scales.y.ticks, callback: v => v + '%' }
                        }
                    }
                }
            });

            // Review Sites Charts
            charts.reviewConv = new Chart(document.getElementById('review-conv-chart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, stacked: true },
                        y: { ...chartOptions.scales.y, stacked: true }
                    }
                }
            });

            charts.reviewCpa = new Chart(document.getElementById('review-cpa-chart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: { ...chartOptions.scales.y, ticks: { ...chartOptions.scales.y.ticks, callback: v => '$' + v } }
                    }
                }
            });

            charts.reviewCost = new Chart(document.getElementById('review-cost-chart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, stacked: true },
                        y: { ...chartOptions.scales.y, stacked: true, ticks: { ...chartOptions.scales.y.ticks, callback: v => '$' + v.toLocaleString() } }
                    }
                }
            });

            // Owned Sites Charts
            charts.ownedConv = new Chart(document.getElementById('owned-conv-chart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, stacked: true },
                        y: { ...chartOptions.scales.y, stacked: true }
                    }
                }
            });

            charts.ownedCpa = new Chart(document.getElementById('owned-cpa-chart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: { ...chartOptions.scales.y, ticks: { ...chartOptions.scales.y.ticks, callback: v => '$' + v } }
                    }
                }
            });

            charts.ownedCost = new Chart(document.getElementById('owned-cost-chart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, stacked: true },
                        y: { ...chartOptions.scales.y, stacked: true, ticks: { ...chartOptions.scales.y.ticks, callback: v => '$' + v.toLocaleString() } }
                    }
                }
            });
        }

        // Update all charts with data
        function updateCharts() {
            if (!apiData) return;

            const monthly = apiData.monthlyTotals || [];
            const labels = monthly.map(m => formatMonth(m.month));

            // All Conversions Chart
            charts.allConv.data.labels = labels;
            charts.allConv.data.datasets = [
                {
                    label: 'Non-Brand',
                    data: monthly.map(m => m.nonBrand?.conversions || 0),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                },
                {
                    label: 'Brand',
                    data: monthly.map(m => m.brand?.conversions || 0),
                    backgroundColor: '#ef4444',
                    borderRadius: 4
                }
            ];
            charts.allConv.update();

            // CPA Trend Chart
            charts.cpaTrend.data.labels = labels;
            charts.cpaTrend.data.datasets = [
                {
                    label: 'Non-Brand CPA',
                    data: monthly.map(m => m.nonBrand?.cpa || 0),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                },
                {
                    label: 'Brand CPA',
                    data: monthly.map(m => m.brand?.cpa || 0),
                    backgroundColor: '#ef4444',
                    borderRadius: 4
                }
            ];
            charts.cpaTrend.update();

            // Cost Distribution Chart (percentage)
            charts.costDist.data.labels = labels;
            const totalSpends = monthly.map(m => (m.total?.spend || 1));
            charts.costDist.data.datasets = [
                {
                    label: 'Non-Brand %',
                    data: monthly.map((m, i) => ((m.nonBrand?.spend || 0) / totalSpends[i]) * 100),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                },
                {
                    label: 'Brand %',
                    data: monthly.map((m, i) => ((m.brand?.spend || 0) / totalSpends[i]) * 100),
                    backgroundColor: '#ef4444',
                    borderRadius: 4
                }
            ];
            charts.costDist.update();

            // Update Review Sites Charts
            const reviewMonthly = apiData.groupTotals?.review || [];
            updateGroupCharts('review', reviewMonthly);

            // Update Owned Sites Charts
            const ownedMonthly = apiData.groupTotals?.owned || [];
            updateGroupCharts('owned', ownedMonthly);
        }

        function updateGroupCharts(group, monthly) {
            const labels = monthly.map(m => formatMonth(m.month));

            // Conversions
            charts[group + 'Conv'].data.labels = labels;
            charts[group + 'Conv'].data.datasets = [
                {
                    label: 'Non-Brand',
                    data: monthly.map(m => m.nonBrand?.conversions || 0),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                },
                {
                    label: 'Brand',
                    data: monthly.map(m => m.brand?.conversions || 0),
                    backgroundColor: '#ef4444',
                    borderRadius: 4
                }
            ];
            charts[group + 'Conv'].update();

            // CPA
            charts[group + 'Cpa'].data.labels = labels;
            charts[group + 'Cpa'].data.datasets = [
                {
                    label: 'Non-Brand CPA',
                    data: monthly.map(m => m.nonBrand?.cpa || 0),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                },
                {
                    label: 'Brand CPA',
                    data: monthly.map(m => m.brand?.cpa || 0),
                    backgroundColor: '#ef4444',
                    borderRadius: 4
                }
            ];
            charts[group + 'Cpa'].update();

            // Cost
            charts[group + 'Cost'].data.labels = labels;
            charts[group + 'Cost'].data.datasets = [
                {
                    label: 'Non-Brand',
                    data: monthly.map(m => m.nonBrand?.spend || 0),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                },
                {
                    label: 'Brand',
                    data: monthly.map(m => m.brand?.spend || 0),
                    backgroundColor: '#ef4444',
                    borderRadius: 4
                }
            ];
            charts[group + 'Cost'].update();
        }

        // Update account details section
        function updateAccountDetails() {
            if (!apiData || !apiData.accounts) return;

            const container = document.getElementById('account-details-container');
            const successAccounts = apiData.accounts.filter(a => a.status === 'success');

            container.innerHTML = successAccounts.map(account => {
                const totals = account.totals || {};
                const monthly = account.monthly || [];
                const chartId = account.name.toLowerCase().replace(/[^a-z0-9]/g, '');

                return `
                    <div class="card mb-4">
                        <div class="card-header">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="account-icon-sm" style="background: ${account.color};">
                                    ${account.name.substring(0, 2).toUpperCase()}
                                </div>
                                <div>
                                    <h2 class="card-title" style="margin: 0;">${account.name}</h2>
                                    <div class="text-muted" style="font-size: 0.85rem;">
                                        ${account.group === 'review' ? 'Review Site' : 'Owned Site'}
                                    </div>
                                </div>
                            </div>
                            <div class="group-stats">
                                <div class="group-stat">
                                    <div class="group-stat-value">${formatCurrency(totals.total?.spend || 0)}</div>
                                    <div class="group-stat-label">Total Spend</div>
                                </div>
                                <div class="group-stat">
                                    <div class="group-stat-value">${formatNumber(totals.total?.conversions || 0)}</div>
                                    <div class="group-stat-label">Conversions</div>
                                </div>
                                <div class="group-stat">
                                    <div class="group-stat-value">${formatCurrency(totals.total?.cpa || 0)}</div>
                                    <div class="group-stat-label">CPA</div>
                                </div>
                                <div class="group-stat">
                                    <div class="group-stat-value brand-color">${formatCurrency(totals.brand?.cpa || 0)}</div>
                                    <div class="group-stat-label">Brand CPA</div>
                                </div>
                                <div class="group-stat">
                                    <div class="group-stat-value nonbrand-color">${formatCurrency(totals.nonBrand?.cpa || 0)}</div>
                                    <div class="group-stat-label">Non-Brand CPA</div>
                                </div>
                            </div>
                        </div>
                        <div class="legend-inline" style="margin-top: 16px;">
                            <div class="legend-item"><div class="legend-dot" style="background: #3b82f6;"></div> Non-Brand</div>
                            <div class="legend-item"><div class="legend-dot" style="background: #ef4444;"></div> Brand</div>
                        </div>
                        <div style="height: 250px; padding: 0 16px 16px;">
                            <canvas id="chart-${chartId}"></canvas>
                        </div>
                    </div>
                `;
            }).join('');

            // Create charts for each account
            successAccounts.forEach(account => {
                const chartId = account.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                const canvas = document.getElementById(`chart-${chartId}`);
                if (!canvas) return;

                const monthly = account.monthly || [];
                const labels = monthly.map(m => formatMonth(m.month));

                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Non-Brand',
                                data: monthly.map(m => m.nonBrand?.conversions || 0),
                                backgroundColor: '#3b82f6',
                                borderRadius: 4
                            },
                            {
                                label: 'Brand',
                                data: monthly.map(m => m.brand?.conversions || 0),
                                backgroundColor: '#ef4444',
                                borderRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' }, stacked: true },
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' }, stacked: true }
                        }
                    }
                });
            });
        }

        // Refresh data
        async function refreshData() {
            const icon = document.getElementById('refresh-icon');
            icon.style.animation = 'spin 1s linear infinite';
            await fetchApiData();
            icon.style.animation = '';
        }

        // Export CSV
        function exportCSV() {
            if (!apiData || !apiData.monthlyTotals) return;

            let csv = 'Month,Total Spend,Total Conv,Total CPA,Brand Spend,Brand Conv,Brand CPA,Non-Brand Spend,Non-Brand Conv,Non-Brand CPA\n';

            for (const m of apiData.monthlyTotals) {
                csv += `${m.month},${(m.total?.spend || 0).toFixed(2)},${m.total?.conversions || 0},${(m.total?.cpa || 0).toFixed(2)},`;
                csv += `${(m.brand?.spend || 0).toFixed(2)},${m.brand?.conversions || 0},${(m.brand?.cpa || 0).toFixed(2)},`;
                csv += `${(m.nonBrand?.spend || 0).toFixed(2)},${m.nonBrand?.conversions || 0},${(m.nonBrand?.cpa || 0).toFixed(2)}\n`;
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `omicron-ppc-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========================================
        // Conversion Action / SKU Breakdown Functions
        // ========================================

        let conversionData = null;
        let selectedConvAccount = 'BUR';
        let convBreakdownChart = null;

        // Color palette for SKU/Brand breakdown (green shades like the PDF)
        const skuColors = [
            '#166534', // Dark green
            '#15803d',
            '#16a34a',
            '#22c55e',
            '#4ade80',
            '#86efac',
            '#bbf7d0',
            '#dcfce7',
            '#134e4a', // Teal variants for variety
            '#0d9488',
            '#14b8a6',
            '#2dd4bf'
        ];

        // Brand colors for review sites (matching Omicron brands in PDF)
        // Conversion actions named like "Offsite Purchase -> Eweka"
        const brandConvColors = {
            'eweka': '#3b82f6',       // Blue (like PDF)
            'newshosting': '#ef4444', // Red
            'easynews': '#f59e0b',    // Amber/Yellow
            'tweaknews': '#22c55e',   // Green
            'tweak': '#22c55e',
            'usenetserver': '#f97316', // Orange
            'sunny': '#eab308',       // Yellow
            'pure': '#6366f1'         // Indigo
        };

        async function refreshConversionData() {
            const icon = document.getElementById('conv-refresh-icon');
            icon.style.animation = 'spin 1s linear infinite';

            const months = document.getElementById('months-selector').value;

            try {
                const response = await fetch(`/api/google-ads/omicron-conversions?months=${months}`);
                conversionData = await response.json();

                if (conversionData.errors && conversionData.errors.length > 0) {
                    console.error('Conversion API errors:', conversionData.errors);
                }

                updateConversionView();
            } catch (error) {
                console.error('Failed to fetch conversion data:', error);
            }

            icon.style.animation = '';
        }

        function selectConversionAccount(accountName) {
            selectedConvAccount = accountName;

            // Update button states
            document.querySelectorAll('.conv-account-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.account === accountName);
            });

            updateConversionView();
        }

        function updateConversionView() {
            if (!conversionData || !conversionData.accounts) return;

            const account = conversionData.accounts.find(a => a.name === selectedConvAccount);
            if (!account || account.status !== 'success') {
                document.getElementById('conv-chart-title').textContent = `${selectedConvAccount}: No Data Available`;
                document.getElementById('conv-totals-table').innerHTML = '<tr><td colspan="3" class="text-muted">No conversion data found for this account</td></tr>';
                return;
            }

            const isReviewSite = account.group === 'review';
            const chartTitle = isReviewSite
                ? `${account.name}: Brand Conversions`
                : `${account.name}: SKU Selection`;

            document.getElementById('conv-chart-title').textContent = chartTitle;

            // Get conversion actions and monthly data
            const actions = account.conversionActions || [];
            const monthly = account.monthly || [];

            // Update legend
            updateConversionLegend(actions, isReviewSite);

            // Update chart
            updateConversionChart(actions, monthly, isReviewSite);

            // Update totals table
            updateConversionTotals(actions, account.totals);
        }

        function updateConversionLegend(actions, isReviewSite) {
            const legendEl = document.getElementById('conv-legend');
            legendEl.innerHTML = actions.slice(0, 10).map((action, i) => {
                const color = getConversionColor(action.name, i, isReviewSite);
                return `<div class="legend-item"><div class="legend-dot" style="background: ${color};"></div> ${action.name}</div>`;
            }).join('');
        }

        function updateConversionChart(actions, monthly, isReviewSite) {
            const canvas = document.getElementById('conv-breakdown-chart');
            const ctx = canvas.getContext('2d');

            // Destroy existing chart
            if (convBreakdownChart) {
                convBreakdownChart.destroy();
            }

            const labels = monthly.map(m => formatMonth(m.month));
            const topActions = actions.slice(0, 10).map(a => a.name);

            const datasets = topActions.map((actionName, i) => {
                const color = getConversionColor(actionName, i, isReviewSite);
                return {
                    label: actionName,
                    data: monthly.map(m => m.actions?.[actionName]?.conversions || 0),
                    backgroundColor: color,
                    borderRadius: 2
                };
            });

            convBreakdownChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatNumber(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            stacked: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateConversionTotals(actions, totals) {
            const tableEl = document.getElementById('conv-totals-table');
            const totalConv = totals?.conversions || actions.reduce((sum, a) => sum + a.conversions, 0);

            tableEl.innerHTML = actions.map(action => {
                const pct = totalConv > 0 ? ((action.conversions / totalConv) * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td>${action.name}</td>
                        <td style="text-align: right;">${formatNumber(action.conversions)}</td>
                        <td style="text-align: right;">${pct}%</td>
                    </tr>
                `;
            }).join('');

            // Add total row
            tableEl.innerHTML += `
                <tr style="font-weight: 600; border-top: 2px solid var(--border);">
                    <td>Total</td>
                    <td style="text-align: right;">${formatNumber(totalConv)}</td>
                    <td style="text-align: right;">100%</td>
                </tr>
            `;
        }

        function getConversionColor(actionName, index, isReviewSite) {
            const lowerName = actionName.toLowerCase();

            if (isReviewSite) {
                // For review sites, try to match brand colors
                for (const [brand, color] of Object.entries(brandConvColors)) {
                    if (lowerName.includes(brand)) {
                        return color;
                    }
                }
            }
            // Default to SKU color palette
            return skuColors[index % skuColors.length];
        }

        // ========================================
        // Initialize
        // ========================================
        initCharts();
        fetchApiData();
        handleHashNavigation(); // Handle direct links like dashboard.html#accounts

        // Add CSS animation for refresh
        const style = document.createElement('style');
        style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(style);
    </script>
</body>
</html>
